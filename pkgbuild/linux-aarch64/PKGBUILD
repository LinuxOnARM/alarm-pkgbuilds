# Package Info
# ------------
# PKGBUILD for linux-aarch64 package
#
# Maintainer: MaxineToTheStars <https://github.com/MaxineToTheStars>
# ------------------------------------------------------------------

# Package Basename
pkgbase=linux

# Package(s)
pkgname=(
    "${pkgbase}-aarch64"
    "${pkgbase}-headers"
    "${pkgbase}-docs"
)

# Package Version
pkgver=6.6.8.aarch64

# Package Release Number
pkgrel=1

# Package Description
pkgdesc='Linux'

# Package URL
url='https://github.com/LinuxOnARM/linux'

# Package Build Targets
arch=( 'aarch64' )

# Package License
license=( 'GPL2' )

# Package Build Dependencies
makedepends=(
    bc
    cpio
    gettext
    graphviz
    imagemagick
    libelf
    pahole
    perl
    python
    python-sphinx
    tar
    texlive-latexextra
    xz
)

# Package Options
options=( '!strip' )

# Package Source Files
_packageSourceName=linux-${pkgver%.*}
source=(
    https://cdn.kernel.org/pub/linux/kernel/v${pkgver%%.*}.x/${_packageSourceName}.tar.{xz,sign}
    config
)

# Package SHA256 Checksums
# https://www.kernel.org/pub/linux/kernel/v6.x/sha256sums.asc
sha256sums=( 5036c434e11e4b36d8da3f489851f7f829cf785fa7f7887468537a9ea4572416 SKIP e0a9158e72579fb1143bf345d981d7da8748848851497d063f38ff8e6448dd2e )

# Package Valid PGP Keys
validpgpkeys=(
    ABAF11C65A2970B130ABE3C479BE3E4300411886  # Linus Torvalds
    647F28654894E3BD457199BE38DBBDC86092693E  # Greg Kroah-Hartman
    A2FF3A36AAA56654109064AB19802F8B0D70FC30  # Jan Alexander Steffens (heftig)
)

# Prepare the package for building
prepare() {
    # Switch to Linux source directory
    cd $_packageSourceName

    # Log
    echo "Setting package version..."

    # Set package version
    echo "-${pkgrel}" > localversion.10-pkgrel
    echo "${pkgbase#linux}" > localversion.20-pkgname

    # Apply patches
    local sourcePackage
    for sourcePackage in "${source[@]}"; do
        # Black magic bash shenanigans
        sourcePackage="${sourcePackage%%::*}"
        sourcePackage="${sourcePackage##*/}"
        sourcePackage="${sourcePackage%.zst}"

        # Was a patch file found
        [[ $sourcePackage = *.patch ]] || continue

        # Log
        echo "Apply patch to Kernel... || ${sourcePackage}"

        # Apply patch
        patch --forward --strip=1 < "../${sourcePackage}"
    done

    # Log
    echo "Setting configuration file..."

    # Set the configuration file
    cp --recursive --update --verbose ../config .config

    # Set Kernel release version
    make --silent kernelrelease > version

    # Log
    echo "Prepared ${pkgbase} || $(<version)"
}

build() {
    # Switch to Linux source directory
    cd $_packageSourceName

    # Build all modules and Kernel for AArch64
    make ARCH=arm64 all

    # Build documentation
    make ARCH=arm64 htmldocs
}
