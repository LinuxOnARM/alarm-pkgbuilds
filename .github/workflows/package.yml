# Workflow Information
# ------------
# Synchronizes, prepares, builds, and publishes packages.
#
# Maintainer: MaxineToTheStars <https://github.com/MaxineToTheStars>
# ------------------------------------------------------------------

# Name of the Workflow
name: Package and Publish

# Name of the Workflow while running
run-name: package-and-publish

# Workflow triggers
on:
  # Workflow triggered every Sunday at midnight
  schedule:
    - cron: "0 0 * * 0"

  # Allow for manual triggers for testing/development
  workflow_dispatch:

# Jobs
jobs:
  # Synchronize the packages first
  synchronize_packages:
    # Run on locally hosted AArch64 runner
    runs-on: [self-hosted, Linux, ARM64, local-rpi-aarch64-1]

    # Job name
    name: Synchronize Package Database

    # Steps
    steps:
      # Clone the repository
      - name: ğŸ“© Cloning Repository ğŸ“©
        uses: actions/checkout@v4

      # Setup Python
      - name: ğŸ Setting-up Python v3.10 ğŸ
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # Switch directories
      - name: ğŸ”€ Switching To Scripts Directory ğŸ”€
        run: cd ./scripts

      # Install Python requirements/dependencies
      - name: ğŸ“² Installing Python Requirements/Dependencies ğŸ“²
        run: pip3 install -r requirements.txt

      # Run sync_package_database.py
      - name: ğŸƒ Running Synchronization Script ğŸƒ
        run: python3 ./sync_package_database.py

      # Commit the new Database
      - name: ğŸš€ Committing The New Database To The Repository ğŸš€
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .
          git commit -m "[Automated Packaging System] Updated Package Database"
          git push

  # Prepare and Build packages
  prepare_and_build_packages:
    # Run on locally hosted AArch64 runner
    runs-on: [self-hosted, Linux, ARM64, local-rpi-aarch64-1]

    # Job name
    name: Prepare and Build Packages

    # Requires for the Synchronization job to finish
    needs: [synchronize_packages]

    # Container setup
    container:
      image: menci/archlinuxarm:base-devel
      options: --cpus 2

    # Steps
    steps:
      # Clone the repository
      - name: ğŸ“© Cloning Repository ğŸ“©
        uses: actions/checkout@v4

      # Setup Python
      - name: ğŸ Setting-up Python v3.10 ğŸ
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # Switch directories
      - name: ğŸ”€ Switching To Scripts Directory ğŸ”€
        run: cd ./scripts

      # Install Python requirements/dependencies
      - name: ğŸ“² Installing Python Requirements/Dependencies ğŸ“²
        run: pip3 install -r requirements.txt

      # Add and Configure GPG Key
      - name: ğŸ” Adding And Configuring GPG Key ğŸ”
        run: |
          echo "${{ secrets.ORG_LINUX_ON_ARM_GPG_KEY }}" >> key.gpg
          pacman-key --add ./key.gpg
          pacman-key --lsign-key ./key.gpg
          sed --in-place "s|^#PACKAGER=.*|PACKAGER=\"LinuxOnARM-Project (Automated Packaging System || https://github.com/LinuxOnARM/alarm-pkgbuilds) <146043018+MaxineToTheStars@users.noreply.github.com>\"|g" /etc/makepkg.conf
          sed --in-place "s|^#GPGKEY=.*|GPGKEY=\"503F278965C391CC\"|g" /etc/makepkg.conf

      # Run prepare_packages.py
      - name: ğŸ› ï¸ Preparing Packages ğŸ› ï¸
        run: pip3 ./prepare_packages.py

      # Run build_packages.py
      - name: ğŸ“¦ Building Packages ğŸ“¦
        run: pip3 ./build_packages.py

      # Commit the new packages
      - name: ğŸš€ Committing The New Packages To The Repository ğŸš€
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .
          git commit -m "[Automated Packaging System] Upload of new Packages"
          git push

  # Publish packages
  publish_packages:
    # Run on locally hosted AArch64 runner
    runs-on: [self-hosted, Linux, ARM64, local-rpi-aarch64-1]

    # Job name
    name: Prepare and Build Packages

    # Requires for the Synchronization job and Prepare and Build job to finish
    needs: [synchronize_packages, prepare_and_build_packages]

    # Set permissions
    permissions:
      pages: write
      contents: write

    # Steps
    steps:
      # Deploy to GitHub pages
      - name: ğŸš€ Deploying To GitHub Pages ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: packages
